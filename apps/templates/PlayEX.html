<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í™ˆíŠ¸ë ˆì´ë‹ ì›¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #466F81;
        }

        .container {
            width: 90%;
            height: 90vh;
            display: grid;
            grid-template-columns: 3fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .webcam {
            grid-column: 1;
            grid-row: 1 / 4;
            background-color: lightgray;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .webcam-caption {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px 20px;
            font-size: 20px;
            border-radius: 10px;
            text-align: left;
            min-height: 120px;
            width: 80%;
            overflow-y: visible;
        }

        #feedbackList {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        #feedbackList li {
            padding: 4px 8px;
            border-bottom: 1px solid #ddd;
            font-size: 18px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .pose-video {
            grid-column: 2;
            grid-row: 1;
            background-color: gray;
            border: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            border-radius: 10px;
            max-width: 1920px;
            aspect-ratio: 16 / 9;
        }

        .exercise-info {
            grid-column: 2;
            grid-row: 2;
            background-color: white;
            border: 1px solid black;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
        }

        .info-box {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            height: 100px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 40px;
            text-align: center;
        }

        .navigation {
            grid-column: 2;
            grid-row: 3;
            background-color: white;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
        }

        #btn-stop {
            width: 100%;
            height: 100%;
            font-size: 24px;
            padding: 20px;
            border: none;
            background-color: #df1b01;
            color: white;
            cursor: pointer;
            border-radius: 10px;
        }

        .circle-timer-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            max-width: 250px;
            margin: auto;
        }

        .progress-ring {
            width: 100%;
            height: 100%;
        }

        .background-ring {
            fill: none;
            stroke: #ddd;
        }

        .foreground-ring {
            fill: none;
            stroke: #4caf50;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
        }

        .timer-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .countdown-text {
            font-size: 70px;
            font-weight: bold;
            text-align: center;
            animation: countdown-blink 1s ease-in-out;
        }

        .waiting-text {
            font-size: 50px;
            color: #ffffff;
            font-style: italic;
            text-align: center;
        }

        #feedbackList li.countdown-text {
            font-size: 70px !important;
            border-bottom: none;
            color: yellow;
            text-align: center;
        }

        #feedbackList.noborder li {
            border-bottom: none;
        }

        .popup {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 40px;
            border: none;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-width: 400px;
            animation: popupSlideIn 0.3s ease-out;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(248, 249, 250, 0.8));
            border-radius: 20px;
            z-index: -1;
        }

        .popup h2 {
            margin-bottom: 20px;
            font-size: 28px;
            color: #2c3e50;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .popup p {
            font-size: 18px;
            margin-bottom: 30px;
            color: #34495e;
            font-weight: 500;
        }

        .popup button {
            margin: 0 10px;
            font-size: 16px;
            font-weight: 600;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .popup button:first-of-type {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .popup button:first-of-type:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .popup button:last-of-type {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .popup button:last-of-type:hover {
            background: linear-gradient(135deg, #d32f2f, #c62828);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.3);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="webcam">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="webcam-caption" id="webcamCaption">
                <ul id="feedbackList">
                    <li id="waitingMessage" class="waiting-text"
                        style="text-align: center; border-bottom: none; width: 100%;">ë™ì‘ ë¶„ì„ ì¤‘...
                    </li>
                </ul>
            </div>
        </div>

        <div class="pose-video">
            <video id="poseVideo" autoplay muted loop playsinline controls
                style="width: 100%; height: 100%; border-radius: 10px;">
                <source src="" type="video/mp4" />
                ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ëŠ” video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </video>
        </div>

        <div class="exercise-info">
            <div class="info-box" id="ex-type">ìš´ë™ ì¢…ë¥˜</div>
            <div class="circle-timer-container">
                <svg class="progress-ring" viewBox="0 0 160 160">
                    <circle class="background-ring" cx="80" cy="80" r="65" stroke-width="8" />
                    <circle class="foreground-ring" cx="80" cy="80" r="65" stroke-width="8" />
                </svg>
                <div class="timer-label" id="timer-label">01:30</div>
            </div>
        </div>

        <div class="navigation">
            <button id="btn-stop" onclick="location.href='/pickex'">ìš´ë™ ê·¸ë§Œë‘ê¸°</button>
        </div>

        <div id="timer-end-popup" class="popup">
            <h2>â° ìš´ë™ì´ ëë‚¬ìŠµë‹ˆë‹¤!</h2>
            <p id="final-time">ìš´ë™ ì‹œê°„: 01:30</p>
            <button onclick="restartTimer()">ë‹¤ì‹œ í•˜ê¸°</button>
            <button onclick="location.href='/pickex'">ìš´ë™ ì„ íƒ</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io("http://localhost:5001");

        // ìš´ë™ ê´€ë ¨ ìƒìˆ˜
        const EXERCISE_CONFIG = {
            burpee: { name: "ë²„í”¼ í…ŒìŠ¤íŠ¸", video: "https://jiy1234.s3.ap-northeast-2.amazonaws.com/burpeetest.mp4" },
            cross_lunge: { name: "í¬ë¡œìŠ¤ ëŸ°ì§€", video: "https://jiy1234.s3.ap-northeast-2.amazonaws.com/crosslunge.mp4" },
            knee_pushup: { name: "ë‹ˆ í‘¸ì‹œì—…", video: "https://jiy1234.s3.ap-northeast-2.amazonaws.com/kneepushup.mp4" },
            pushup: { name: "í‘¸ì‹œì—…", video: "https://jiy1234.s3.ap-northeast-2.amazonaws.com/pushup.mp4" },
            plank: { name: "í”Œë­í¬", video: "https://jiy1234.s3.ap-northeast-2.amazonaws.com/plank.mp4" },
            side_lunge: { name: "ì‚¬ì´ë“œ ëŸ°ì§€", video: "https://jiy1234.s3.ap-northeast-2.amazonaws.com/sidelunge.mp4" }
        };

        // íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜
        let timerInterval = null;
        const totalSeconds = 90;
        let currentSeconds = totalSeconds;
        let startTime = null;

        // DOM ìš”ì†Œë“¤
        const timerLabel = document.getElementById("timer-label");
        const foregroundRing = document.querySelector(".foreground-ring");
        const feedbackList = document.getElementById("feedbackList");

        // WebRTC ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€
        let peerConnection = null;
        let localStream = null;

        // ì†Œì¼“ ì—°ê²°
        socket.on("connect", () => {
            console.log("âœ… WebSocket ì—°ê²°ë¨");
        });

        socket.on("disconnect", () => {
            console.log("âŒ WebSocket ì—°ê²° ëŠì–´ì§");
        });

        socket.on("feedback", (data) => {
            try {
                const message = data.message;
                const waitingMsg = document.getElementById("waitingMessage");

                if (waitingMsg) {
                    waitingMsg.remove();
                }

                if (message.startsWith("ğŸ“Œ")) {
                    feedbackList.innerHTML = "";
                    return;
                }

                const li = document.createElement("li");
                li.textContent = message;
                feedbackList.appendChild(li);
            } catch (error) {
                console.error("í”¼ë“œë°± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
            }
        });

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getExerciseFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("exercise");
        }

        function formatTime(seconds) {
            const min = String(Math.floor(seconds / 60)).padStart(2, '0');
            const sec = String(seconds % 60).padStart(2, '0');
            return `${min}:${sec}`;
        }

        function getElapsedTime() {
            if (!startTime) return 0;
            return Math.floor((Date.now() - startTime) / 1000);
        }

        // ìš´ë™ ì„¤ì • í•¨ìˆ˜ë“¤
        function initializeExercise() {
            const exercise = getExerciseFromURL();
            const config = EXERCISE_CONFIG[exercise] || EXERCISE_CONFIG.burpee;

            // ìš´ë™ ì´ë¦„ ì„¤ì •
            document.getElementById("ex-type").innerText = config.name;

            // ë¹„ë””ì˜¤ ì„¤ì •
            const videoTag = document.getElementById("poseVideo");
            const sourceTag = videoTag.querySelector("source");
            sourceTag.src = config.video;
            videoTag.load();
            videoTag.play().catch(error => {
                console.error("ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", error);
            });
        }

        // íƒ€ì´ë¨¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function initializeTimer() {
            const radius = 65; // 85ì—ì„œ 65ë¡œ ë³€ê²½
            const circumference = 2 * Math.PI * radius;
            foregroundRing.style.strokeDasharray = circumference;
            foregroundRing.style.strokeDashoffset = 0;
        }

        function updateRingProgress() {
            const radius = 65; // 85ì—ì„œ 65ë¡œ ë³€ê²½
            const circumference = 2 * Math.PI * radius;
            const percent = currentSeconds / totalSeconds;
            const offset = circumference * (1 - percent);
            foregroundRing.style.strokeDashoffset = offset;

            // ìƒ‰ìƒ ë³€ê²½
            if (percent <= 0.11) {
                foregroundRing.style.stroke = "#f44336"; // ë¹¨ê°•
            } else if (percent <= 0.33) {
                foregroundRing.style.stroke = "#ff9800"; // ì£¼í™©
            } else {
                foregroundRing.style.stroke = "#4caf50"; // ì´ˆë¡
            }
        }

        function startCountdownAndTimer() {
            let count = 5;
            feedbackList.classList.add("noborder");
            feedbackList.innerHTML = "";

            const countdownInterval = setInterval(() => {
                const countdownLi = document.createElement("li");
                countdownLi.className = "countdown-text";
                countdownLi.textContent = count;

                feedbackList.innerHTML = "";
                feedbackList.appendChild(countdownLi);

                count--;

                if (count < 0) {
                    clearInterval(countdownInterval);
                    feedbackList.innerHTML = "";
                    feedbackList.classList.remove("noborder");
                    startCircularTimer();
                }
            }, 1000);
        }

        function startCircularTimer() {
            // ì‹œì‘ ì‹œê°„ ê¸°ë¡
            startTime = Date.now();

            // í”¼ë“œë°± ì˜ì—­ ì´ˆê¸°í™” ë° ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
            feedbackList.innerHTML = '<li id="waitingMessage">ë™ì‘ ë¶„ì„ ì¤‘...</li>';

            currentSeconds = totalSeconds;
            clearInterval(timerInterval);
            updateRingProgress();

            timerInterval = setInterval(() => {
                timerLabel.textContent = formatTime(currentSeconds);
                updateRingProgress();

                if (currentSeconds <= 0) {
                    clearInterval(timerInterval);
                    stopAllActivities(); // ëª¨ë“  ë™ì‘ ì¤‘ì§€
                    const elapsedTime = getElapsedTime();
                    document.getElementById("final-time").innerText = `ìš´ë™ ì‹œê°„: ${formatTime(elapsedTime)}`;
                    document.getElementById("timer-end-popup").style.display = "block";
                }

                currentSeconds--;
            }, 1000);
        }

        // ëª¨ë“  ë™ì‘ ì¤‘ì§€ í•¨ìˆ˜
        function stopAllActivities() {
            console.log("ğŸ›‘ ëª¨ë“  ë™ì‘ì„ ì¤‘ì§€í•©ë‹ˆë‹¤...");

            // 1. ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    console.log("ğŸ“¹ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€ë¨");
                });
            }

            // 2. WebRTC ì—°ê²° ì¢…ë£Œ
            if (peerConnection) {
                peerConnection.close();
                console.log("ğŸ”— WebRTC ì—°ê²° ì¢…ë£Œë¨");
            }

            // 3. ê°€ì´ë“œ ë¹„ë””ì˜¤ ì¼ì‹œ ì •ì§€
            const poseVideo = document.getElementById("poseVideo");
            if (poseVideo) {
                poseVideo.pause();
                console.log("â¸ï¸ ê°€ì´ë“œ ë¹„ë””ì˜¤ ì¼ì‹œ ì •ì§€ë¨");
            }

            // 4. ì†Œì¼“ í”¼ë“œë°± ìˆ˜ì‹  ì¤‘ì§€ (ì†Œì¼“ì€ ìœ ì§€í•˜ë˜ í”¼ë“œë°±ë§Œ ë¬´ì‹œ)
            socket.off("feedback");
            console.log("ğŸ“¡ í”¼ë“œë°± ìˆ˜ì‹  ì¤‘ì§€ë¨");

            // 5. ì›¹ìº  ë¹„ë””ì˜¤ ì¼ì‹œ ì •ì§€
            const localVideo = document.getElementById("localVideo");
            if (localVideo && localVideo.srcObject) {
                localVideo.pause();
                console.log("ğŸ“· ì›¹ìº  ë¹„ë””ì˜¤ ì¼ì‹œ ì •ì§€ë¨");
            }
        }

        function restartTimer() {
            document.getElementById("timer-end-popup").style.display = "none";

            // ëª¨ë“  ë™ì‘ ë‹¤ì‹œ ì‹œì‘
            console.log("ğŸ”„ ìš´ë™ì„ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤...");

            // ê°€ì´ë“œ ë¹„ë””ì˜¤ ì¬ìƒ
            const poseVideo = document.getElementById("poseVideo");
            if (poseVideo) {
                poseVideo.play();
            }

            // ì†Œì¼“ í”¼ë“œë°± ë‹¤ì‹œ ì—°ê²°
            socket.on("feedback", (data) => {
                try {
                    const message = data.message;
                    const waitingMsg = document.getElementById("waitingMessage");

                    if (waitingMsg) {
                        waitingMsg.remove();
                    }

                    if (message.startsWith("ğŸ“Œ")) {
                        feedbackList.innerHTML = "";
                        return;
                    }

                    const li = document.createElement("li");
                    li.textContent = message;
                    feedbackList.appendChild(li);
                } catch (error) {
                    console.error("í”¼ë“œë°± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                }
            });

            // WebRTC ë‹¤ì‹œ ì—°ê²°
            startWebRTC();

            // íƒ€ì´ë¨¸ ë‹¤ì‹œ ì‹œì‘
            startCircularTimer();
        }

        // WebRTC ê´€ë ¨ í•¨ìˆ˜
        async function startWebRTC() {
            try {
                peerConnection = new RTCPeerConnection(); // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
                localStream = await navigator.mediaDevices.getUserMedia({ // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
                    video: true,
                    audio: false
                });

                document.getElementById("localVideo").srcObject = localStream;
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                const exercise = getExerciseFromURL();
                const userId = sessionStorage.getItem("user_id");
                console.log("ğŸ“Œ ì „ë‹¬í•  user_id:", userId);  // ë””ë²„ê¹…ìš© ì¶œë ¥

                const res = await fetch("http://localhost:8080/offer", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sdp: peerConnection.localDescription.sdp,
                        type: peerConnection.localDescription.type,
                        exercise: exercise,
                        user_id: userId
                    })
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const answer = await res.json();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));

                console.log("âœ… WebRTC ì—°ê²° ì„±ê³µ");
            } catch (error) {
                console.error("WebRTC ì—°ê²° ì˜¤ë¥˜:", error);
                alert("ì¹´ë©”ë¼ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            }
        }

        // ì´ˆê¸°í™”
        window.onload = () => {
            try {
                initializeExercise();
                initializeTimer();
                startWebRTC();
                startCountdownAndTimer();
            } catch (error) {
                console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
            }
        };

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.onbeforeunload = () => {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        };
    </script>
</body>

</html>